events {
    worker_connections 1024;
}

http {
    # Logging configuration
    access_log /var/log/nginx/forward-access.log;
    error_log /var/log/nginx/forward-error.log;

    # Forward Proxy Server Configuration
    # This acts as a FORWARD PROXY - client must explicitly configure it
    # Client sends requests THROUGH this proxy to reach external sites
    
    server {
        listen 8888;
        server_name localhost;

        # Add header to show this is a forward proxy
        add_header X-Proxy-Type "Forward-Proxy" always;

        # DNS resolver (required for forward proxy to resolve external domains)
        resolver 8.8.8.8 8.8.4.4 valid=300s;
        resolver_timeout 5s;

        # ========================================
        # FORWARD PROXY - WHITELISTED DOMAINS
        # ========================================
        # These domains are ALLOWED through the forward proxy

        # Allow JSONPlaceholder API
        location ~ ^/https://jsonplaceholder\.typicode\.com {
            rewrite ^/(https?://[^/]+)/(.*) /$2 break;
            proxy_pass https://jsonplaceholder.typicode.com;
            proxy_ssl_server_name on;
            proxy_set_header Host jsonplaceholder.typicode.com;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Allow GitHub API
        location ~ ^/https://api\.github\.com {
            rewrite ^/(https?://[^/]+)/(.*) /$2 break;
            proxy_pass https://api.github.com;
            proxy_ssl_server_name on;
            proxy_set_header Host api.github.com;
            proxy_set_header User-Agent "Forward-Proxy-Demo";
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Allow example.com for testing
        location ~ ^/http://example\.com {
            rewrite ^/(https?://[^/]+)/(.*) /$2 break;
            proxy_pass http://example.com;
            proxy_set_header Host example.com;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ========================================
        # BLOCK ALL OTHER DOMAINS
        # ========================================
        # This is the key behavior of a forward proxy with filtering
        
        location / {
            return 403 '{"error": "Access Forbidden", "message": "This domain is not whitelisted in the forward proxy. Only specific domains are allowed.", "proxy_type": "forward", "allowed_domains": ["jsonplaceholder.typicode.com", "api.github.com", "example.com"]}';
            add_header Content-Type application/json;
        }

        # ========================================
        # PROXY STATUS
        # ========================================
        
        location /proxy-info {
            return 200 '{
                "proxy_type": "forward",
                "description": "This is a FORWARD PROXY - clients must explicitly configure their browser/app to use this proxy",
                "port": 8888,
                "whitelisted_domains": [
                    "jsonplaceholder.typicode.com",
                    "api.github.com",
                    "example.com"
                ],
                "usage": "Configure your client to use http://localhost:8888 as HTTP proxy",
                "test_command": "curl -x http://localhost:8888 http://example.com"
            }';
            add_header Content-Type application/json;
        }
    }
}
